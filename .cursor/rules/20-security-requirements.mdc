---
description: "Security requirements and patterns for path traversal, input validation, and authentication"
globs: "backend/**/*.py"
---

# Security Requirements

When working with backend code, always follow these security patterns.

## CRITICAL: Path Traversal Protection

**Always validate file paths before operations.** See [backend/app/services/file_service.py](mdc:backend/app/services/file_service.py) for examples.

### Required Pattern

```python
import os
from pathlib import Path

def validate_path(vault_path: str, user_path: str) -> Path:
    """Validate and resolve user-provided path to prevent directory traversal.
    
    Args:
        vault_path: Base vault directory
        user_path: User-provided relative path
        
    Returns:
        Resolved absolute path
        
    Raises:
        HTTPException: If path is outside vault directory
    """
    # Convert vault_path to absolute path
    vault_absolute = Path(os.path.abspath(vault_path))
    
    # Join and resolve user path
    target_path = vault_absolute / user_path
    resolved_path = target_path.resolve()
    
    # Verify that resolved path is within vault
    try:
        resolved_path.relative_to(vault_absolute)
    except ValueError:
        raise HTTPException(
            status_code=403,
            detail="Path outside vault directory is not allowed"
        )
    
    return resolved_path
```

### Key Security Rules

1. **Never allow `../` in file paths**
2. **Always use `os.path.abspath()` and `os.path.commonpath()`**
3. **Sanitize user input before file operations**
4. **Validate path boundaries**

## Input Validation

### Use Pydantic Models

Always use Pydantic models for request validation (see [backend/app/models/](mdc:backend/app/models/)):
```python
from pydantic import BaseModel, validator

class CreateFileRequest(BaseModel):
    path: str
    content: str
    
    @validator('path')
    def validate_path(cls, v):
        if '..' in v:
            raise ValueError('Path traversal not allowed')
        return v
```

### Validation Checklist

- Validate all user inputs
- Sanitize file uploads
- Validate file types and sizes
- Check for malicious patterns
- Limit file name lengths
- Restrict allowed characters

## Authentication

### JWT Implementation

See [backend/app/core/auth.py](mdc:backend/app/core/auth.py):
- Use `get_current_user` dependency in protected endpoints
- Store tokens in httpOnly cookies
- Implement token refresh mechanism
- Validate tokens on every protected endpoint

### Protected Endpoints

All endpoints except these require authentication:
- `GET /` - Root
- `GET /health` - Health check
- `GET /docs` - API documentation
- `POST /api/v1/auth/login` - Login

Example:
```python
from app.core.auth import get_current_user
from fastapi import Depends

@router.get("/api/v1/notes/")
async def list_notes(
    current_user: dict = Depends(get_current_user)
):
    """List all notes - requires authentication."""
    # Implementation
```

## File Type Validation

Only allow markdown files:
```python
def validate_markdown_file(path: str) -> bool:
    """Validate that file is a markdown file."""
    return path.endswith('.md') or path.endswith('.markdown')
```

## Security Testing

Test security features explicitly (see [backend/tests/test_notes_auth.py](mdc:backend/tests/test_notes_auth.py)):
- Test path traversal attempts
- Test invalid input patterns
- Test authentication on all protected endpoints
- Test authorization boundaries